# processes-api

Proof of Concept for OAPIP-based processor in KomMonitor


# Get Started:

## Docker Setup

A `Dockerfile` is provided for building a image of the pygeoapi. A full infrastructure with all required associated KomMonitor components is provided as a `docker-compose` in the `docker` subdirectory.


## Usage 

The API requires the client to provide an `access_token` for most requests. This must be acquired manually beforehand by querying the Keycloak server.

```bash
curl --request POST \
  --url https://keycloak:8080/realms/kommonitor/protocol/openid-connect/token \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data grant_type=password \
  --data username=<username> \
  --data password=<password> \
  --data client_id=kommonitor-web-client
```

Using this token the endpoints provided by the OGC API Processes can be queried. Refer to the [OGC API - Processes Specification](https://ogcapi.ogc.org/processes/) for a list of available Endpoints and Operations. Note that not all Workflows are currently supported.

### Example Requests

- Query Jobs
```bash
curl --request GET \
  --url https://<localhost>/processor/jobs \
  --header 'Authorization: Bearer <access_token>'
```
- Start Process `aggregate_sum`:
```bash
curl --request POST \
  --url https://<localhost>/processor/processes/aggregate_sum/execution \
  --header 'Authorization: Bearer <access_token>' \
  --header 'Content-Type: application/json' \
  --data '{
  "inputs": {
    "georesource_id": "8e216371-874f-4e8b-8a60-fe5bdce6ca96",
    "spatial_unit_id": "4f8f3a04-cc57-48d3-a801-d6b4b00fd315",
    "target_date": "2000-01-01"
  }
}'
```

# Development

The project includes several python packages and submodules

## processor
Subfolder: `processor`

Provides the core implementation of the KomMonitor processes-api. 

### Installation

Installing required python packages

```bash
# Install requirements
pip install -r requirements.txt
pip install --no-deps -r requirements_nodeps.txt
```
### Running

The application is packaged as an executable `app.py` script. Configuration is based on the following environment variables which should be set accordingly prior to starting:

| name             | description                                       |
|------------------|---------------------------------------------------|
| KC_CLIENT        | Identifier of Keycloak client                     |
| KC_CLIENT_SECRET | Secret of Keycloak client                         |
| KC_HOST          | Hostname of Keycloak Server `(e.g. keycloak:8080` |
| KC_HOSTNAME_PATH | Subpath of Keycloak Hostname (e.g. /keycloak)     |
| KC_REALM_NAME    | Name of the Keycloak realm                        |

After these variables are set run the app via
```commandline
python3 app.py
```

### Structure

| name    | description                                                       |
|---------|-------------------------------------------------------------------|
| process | python package containing implementations of executable processes |
| static  | static files used by the pygeoapi dashboard                       |

## api-specs
Subfolder: `api-specs`

Local submodule integrating [https://github.com/KomMonitor/api-specs/](KomMonitor api-specs Repository), providing OpenAPI specifications of KomMonitor APIs.

## data-management-client
Subfolder: `data-management-client`

Client to connect to the KomMonitor data-management API.

### Building 

The package content is autogenerated based on the data-management API specification using the `openapitools generator cli`

```bash
docker run --rm -v $PWD:/local openapitools/openapi-generator-cli generate -i /local/api-specs/src/specs/data-management/kommonitor_dataAccessAPI.yaml -g python -o /local/data-management-client
```